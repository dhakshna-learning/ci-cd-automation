name: CD deployment Pipeline

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      jira_ref:
        required: false
        type: string
      issue_number:
        required: false
        type: string
      debug:
        required: false
        type: string
      promote2prd:
        required: true
        type: boolean

    outputs:
       markers:
        description: "Markers"
        value: ${{ jobs.deployment-markers.outputs.marker }}

permissions:
  id-token: write  
  contents: read

jobs:
  wait-for-approval:
    if: ${{ inputs.environment != 'Dev' }}
    name: Wait-for-Approval
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      devops_ids: ${{ steps.fetch_approvers.outputs.devops_ids }}
      test_ids: ${{ steps.fetch_approvers.outputs.test_ids }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: dhakshna-learning/ci-cd-automation
          ref: master
          path: ci-cd-automation
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: get-ids
        id: fetch_approvers
        uses: dhakshna-learning/ci-cd-automation/.github/actions/get-ids@master
        with:
          branch: ${{ github.ref }}
          debug: ${{ inputs.Debug }}
      
      - name: Retrieve the Issue number
        id: get-issue
        shell: bash
        run: |
          ISSUE_ID=${{ inputs.issue_number }} >> "$GITHUB_OUTPUT"
          
          if [ -z "$ISSUE_ID" ]; then
            echo "Error: ISSUE_ID is empty"
            exit 1
          fi
          echo "Issue ID: $ISSUE_ID"

      - name: Wait for Approval
        uses: dhakshna-learning/ci-cd-automation/.github/actions/retrieve-issues@master
        id: wait_approval
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          approvers: ${{ steps.fetch_approvers.outputs.devops_ids }}

  deploy2Dev:
    name: Dev Deployment
    if: ${{ inputs.environment == 'Dev' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Deploying to ${{ inputs.environment }} environment
        run: |
          echo "Deploying to ${{ inputs.environment }} environment..."
          # Add your deployment commands here
          echo "Deployment to ${{ inputs.environment }} completed."
  
  deploy2Reg:
    name: Deployment to Regression
    needs: wait-for-approval
    if: ${{ inputs.environment != 'Dev' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: update comments
        uses: dhakshna-learning/ci-cd-automation/.github/actions/update-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          update-message: "Initiating the Regression Deployment ðŸš€"
          
      - name: Deployment to regression environments
        id: reg-deployment
        run: |
          echo "Deploying to Reg environment..."
          # Add your deployment commands here
          echo "Deployment to ${{ inputs.environment }} completed."

      - name: Waiting for Reg validation to be completed
        id: reg-approval
        uses: dhakshna-learning/ci-cd-automation/.github/actions/post-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          approvers: ${{ needs.wait-for-approval.outputs.test_ids }}
          approval-message: "Regression Deployment is completed ðŸŽ¯, please validate and approve to proceed further...!"
          labels: "Reg"
          
  deploy2Prl:  
    name: Deployment to Prelive
    needs: [wait-for-approval,deploy2Reg]
    if: ${{ inputs.environment != 'Dev' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: update comments
        uses: dhakshna-learning/ci-cd-automation/.github/actions/update-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          update-message: "Initiating the Sublive Deployment ðŸš€"
          
      - name: Deployment to Prelive environments
        id: prl-deployment
        run: |
          echo "Deploying to Reg environment..."
          # Add your deployment commands here
          echo "Deployment to ${{ inputs.environment }} completed."

      - name: Waiting for Prl validation to be completed
        id: prl-approval
        uses: dhakshna-learning/ci-cd-automation/.github/actions/post-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          approvers: ${{ needs.wait-for-approval.outputs.test_ids }}
          approval-message: "Prelive Deployment is completed ðŸŽ¯, please validate and approve to proceed further...!"
          labels: "Sublive"

  deploy2Prd:  
    name: Deployment to Production
    needs: [wait-for-approval,deploy2Reg,deploy2Prl]
    if: ${{ inputs.promote2prd == 'True' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: update comments
        uses: dhakshna-learning/ci-cd-automation/.github/actions/update-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          update-message: "Initiating the Live Deployment ðŸš€"
          
      - name: Deployment to Prod environments
        id: prd-deployment
        run: |
          echo "Deploying to Prd environment..."
          # Add your deployment commands here
          echo "Deployment to ${{ inputs.environment }} completed."

      - name: Waiting for Prd validation to be completed
        id: prd-approval
        uses: dhakshna-learning/ci-cd-automation/.github/actions/post-comments@master
        with:
          mode: "wait"
          issue-number: ${{ inputs.issue_number  }}
          secret: ${{ secrets.PEM_KEY }}
          approvers: ${{ needs.wait-for-approval.outputs.test_ids }}
          approval-message: "Production Deployment is completed ðŸŽ¯, please validate and approve to proceed further...!"
          labels: "Production"  

  deployment-markers:
      name: deployment-markers
      needs: [deploy2Prd]
      runs-on: ubuntu-latest
      outputs:
        marker: ${{ steps.markers.outputs.deployment_status }}
      steps:
        - name: mark-deployments
          id: markers
          run: |
            export deployemt_status="completed" >> $GITHUB_OUTPUT
          
